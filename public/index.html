<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPVideos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-red: #d32f2f; --dark-red: #b71c1c; --light-red: #ff6659;
            --black: #121212; --dark-gray: #1e1e1e; --medium-gray: #2d2d2d;
            --light-gray: #e0e0e0; --white: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.5); --border-radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--black); color: var(--white); line-height: 1.6; }
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: block; }
        
        /* Header principal */
        .main-header { background: var(--dark-gray); padding: 1.5rem 2rem; display: flex; 
            justify-content: space-between; align-items: center; box-shadow: var(--shadow); 
            border-bottom: 3px solid var(--primary-red); position: sticky; top: 0; z-index: 1000; }
        .main-header h1 { font-size: 1.8rem; color: var(--primary-red); display: flex; align-items: center; gap: 10px; }
        .upload-button { background: var(--primary-red); color: var(--white); border: none; 
            padding: 0.8rem 1.5rem; border-radius: var(--border-radius); font-weight: 600; 
            cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .upload-button:hover { background: var(--dark-red); transform: translateY(-2px); }
        
        /* Grid de videos */
        .video-grid-container { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .video-grid-container h2 { font-size: 1.8rem; margin-bottom: 1.5rem; color: var(--light-gray); }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; }
        .video-card { background: var(--dark-gray); border-radius: var(--border-radius); overflow: hidden; 
            box-shadow: var(--shadow); transition: all 0.3s; cursor: pointer; border: 2px solid transparent; }
        .video-card:hover { transform: translateY(-8px); border-color: var(--primary-red); }
        .video-thumbnail { position: relative; width: 100%; height: 200px; overflow: hidden; background: var(--medium-gray); }
        .video-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .video-duration { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); 
            color: var(--white); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .video-info { padding: 1.2rem; }
        .video-info h3 { font-size: 1.1rem; margin-bottom: 0.5rem; display: -webkit-box; 
            -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .video-meta { display: flex; justify-content: space-between; color: var(--light-gray); font-size: 0.85rem; }
        
        /* Pantalla de subida */
        .upload-header { background: var(--dark-gray); padding: 1.5rem 2rem; display: flex; align-items: center; 
            box-shadow: var(--shadow); border-bottom: 3px solid var(--primary-red); }
        .back-button { background: var(--medium-gray); color: var(--white); border: none; width: 40px; height: 40px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; 
            font-size: 1.2rem; transition: all 0.3s; }
        .back-button:hover { background: var(--primary-red); transform: scale(1.1); }
        .upload-container { max-width: 800px; margin: 2rem auto; padding: 0 2rem; }
        .upload-area { background: var(--dark-gray); border: 3px dashed var(--primary-red); 
            border-radius: var(--border-radius); padding: 3rem 2rem; text-align: center; cursor: pointer; 
            transition: all 0.3s; }
        .upload-area:hover { background: var(--medium-gray); border-color: var(--light-red); }
        .upload-area i { font-size: 4rem; color: var(--primary-red); margin-bottom: 1.5rem; }
        .upload-progress-container { background: var(--medium-gray); border-radius: 8px; padding: 1.2rem; margin: 1.5rem 0; }
        .progress-bar { width: 100%; height: 12px; background: var(--black); border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary-red); border-radius: 6px; width: 0%; transition: width 0.3s; }
        
        /* Pantalla de reproducción */
        .player-container { max-width: 1000px; margin: 2rem auto; padding: 0 2rem; }
        .video-player-wrapper { background: var(--black); border-radius: var(--border-radius); overflow: hidden; margin-bottom: 2rem; }
        #video-player { width: 100%; max-height: 70vh; display: block; }
        .download-btn { background: var(--primary-red); color: var(--white); border: none; 
            padding: 0.9rem 2rem; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; 
            transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        .download-btn:hover { background: var(--dark-red); transform: translateY(-2px); }
        
        @media (max-width: 768px) {
            .video-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1.5rem; }
            .main-header, .upload-header { padding: 1rem; }
            .video-grid-container, .upload-container, .player-container { padding: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Pantalla Principal -->
    <div id="main-screen" class="screen active">
        <header class="main-header">
            <h1><i class="fas fa-play-circle"></i>CPVideos</h1>
            <button id="upload-btn" class="upload-button"><i class="fas fa-upload"></i> Subir Video</button>
        </header>
        <main class="video-grid-container">
            <h2>Videos</h2>
            <div id="video-grid" class="video-grid"></div>
        </main>
    </div>

    <!-- Pantalla de Subida -->
    <div id="upload-screen" class="screen">
        <header class="upload-header">
            <button id="back-from-upload-btn" class="back-button"><i class="fas fa-arrow-left"></i></button>
            <h2>Subir Video</h2>
        </header>
        <div class="upload-container">
            <div class="upload-area" id="upload-area">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Arrastra y suelta tu video</h3>
                <p>o haz clic para seleccionar</p>
                <input type="file" id="video-input" accept="video/*" style="display: none;">
                <button id="select-video-btn" class="upload-button" style="margin-top: 1rem;">Seleccionar Video</button>
            </div>
            <div id="upload-details" class="upload-details" style="display: none; background: var(--dark-gray); padding: 2rem; border-radius: var(--border-radius); margin-top: 2rem;">
                <h3>Procesando video...</h3>
                <div class="upload-progress-container">
                    <div class="progress-info">
                        <span id="progress-text">0%</span>
                        <span id="upload-speed">0 KB/s</span>
                    </div>
                    <div class="progress-bar">
                        <div id="upload-progress" class="progress-fill"></div>
                    </div>
                </div>
                <div id="upload-actions" style="display: none; margin-top: 1.5rem;">
                    <button id="cancel-upload-btn" class="upload-button" style="background: var(--medium-gray);">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla de Reproducción -->
    <div id="player-screen" class="screen">
        <header class="upload-header">
            <button id="close-player-btn" class="back-button"><i class="fas fa-times"></i></button>
            <h2>Reproduciendo Video</h2>
        </header>
        <div class="player-container">
            <div class="video-player-wrapper">
                <video id="video-player" controls autoplay></video>
            </div>
            <div style="background: var(--dark-gray); padding: 2rem; border-radius: var(--border-radius);">
                <h3 id="video-player-title">Título del Video</h3>
                <div class="video-meta" style="margin: 1rem 0; color: var(--light-gray);">
                    <span id="video-duration"><i class="fas fa-clock"></i> 0:00</span>
                    <span id="video-views"><i class="fas fa-eye"></i> 0 vistas</span>
                </div>
                <button id="download-btn" class="download-btn"><i class="fas fa-download"></i> Descargar Video</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Variables globales
        let videos = [];
        let selectedFile = null;
        let uploadInProgress = false;
        let socket = io();
        
        // Elementos del DOM
        const screens = {
            main: document.getElementById('main-screen'),
            upload: document.getElementById('upload-screen'),
            player: document.getElementById('player-screen')
        };
        
        // Navegación entre pantallas
        function switchScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
            if (screenName === 'main') loadVideos();
        }
        
        // Cargar videos desde la API
        async function loadVideos() {
            try {
                const response = await fetch('/api/videos');
                videos = await response.json();
                renderVideoGrid();
            } catch (error) {
                console.error('Error cargando videos:', error);
                document.getElementById('video-grid').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:4rem;color:var(--light-gray);">Error cargando videos</div>';
            }
        }
        
        // Renderizar grid de videos
        function renderVideoGrid() {
            const grid = document.getElementById('video-grid');
            if (videos.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:4rem;color:var(--light-gray);">No hay videos. ¡Sube el primero!</div>';
                return;
            }
            
            grid.innerHTML = videos.map(video => `
                <div class="video-card" data-id="${video.id}">
                    <div class="video-thumbnail">
                        <img src="${video.thumbnail || 'https://placehold.co/400x225/d32f2f/000000?text=Video'}" alt="${video.title}">
                        <span class="video-duration">${video.duration || '0:00'}</span>
                    </div>
                    <div class="video-info">
                        <h3>${video.title}</h3>
                        <div class="video-meta">
                            <span>${video.size || '0 MB'}</span>
                            <span>${new Date(video.uploaded_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Agregar event listeners
            document.querySelectorAll('.video-card').forEach(card => {
                card.addEventListener('click', () => openVideoPlayer(card.dataset.id));
            });
        }
        
        // Abrir reproductor
        function openVideoPlayer(videoId) {
            const video = videos.find(v => v.id == videoId);
            if (!video) return;
            
            document.getElementById('video-player').src = video.url;
            document.getElementById('video-player-title').textContent = video.title;
            document.getElementById('video-duration').innerHTML = `<i class="fas fa-clock"></i> ${video.duration}`;
            document.getElementById('video-views').innerHTML = `<i class="fas fa-eye"></i> ${video.views} vistas`;
            
            // Configurar descarga
            document.getElementById('download-btn').onclick = () => {
                window.open(`/api/videos/${videoId}/download`, '_blank');
            };
            
            switchScreen('player');
        }
        
        // Configurar WebSocket
        socket.on('video-uploaded', (video) => {
            console.log('Nuevo video subido:', video);
            // Recargar videos si estamos en la pantalla principal
            if (screens.main.classList.contains('active')) {
                loadVideos();
            }
        });
        
        socket.on('video-processed', (data) => {
            console.log('Video procesado:', data);
            loadVideos(); // Recargar para mostrar miniatura y duración
        });
        
        // Configurar eventos
        document.getElementById('upload-btn').addEventListener('click', () => switchScreen('upload'));
        document.getElementById('back-from-upload-btn').addEventListener('click', () => switchScreen('main'));
        document.getElementById('close-player-btn').addEventListener('click', () => switchScreen('main'));
        
        // Subida de videos
        const videoInput = document.getElementById('video-input');
        document.getElementById('select-video-btn').addEventListener('click', () => videoInput.click());
        document.getElementById('upload-area').addEventListener('click', () => videoInput.click());
        
        videoInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 100 * 1024 * 1024) {
                alert('El video debe ser menor a 100MB');
                return;
            }
            
            selectedFile = file;
            document.getElementById('upload-details').style.display = 'block';
            
            // Subir el video
            const formData = new FormData();
            formData.append('video', file);
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/upload');
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    document.getElementById('upload-progress').style.width = percent + '%';
                    document.getElementById('progress-text').textContent = percent + '%';
                }
            });
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    document.getElementById('progress-text').textContent = '¡Subida completa!';
                    setTimeout(() => switchScreen('main'), 2000);
                } else {
                    alert('Error subiendo el video');
                }
            };
            
            xhr.send(formData);
        });
        
        // Inicializar
        loadVideos();
    </script>
</body>
</html>