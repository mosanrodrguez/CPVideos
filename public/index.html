<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPVideos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-red: #d32f2f; --dark-red: #b71c1c; --light-red: #ff6659;
            --black: #121212; --dark-gray: #1a1a1a; --medium-gray: #2a2a2a;
            --light-gray: #e0e0e0; --white: #ffffff;
            --shadow: 0 3px 10px rgba(0,0,0,0.5); --border-radius: 8px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: var(--black); 
            color: var(--white);
            min-height: 100vh;
        }
        
        /* ========== PANTALLA PRINCIPAL ========== */
        .main-screen.active { 
            display: block; 
            min-height: 100vh;
        }
        
        .main-screen { display: none; }
        
        /* Header - TEXTO REDUCIDO */
        .main-header { 
            background: var(--dark-gray); 
            padding: 12px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid var(--primary-red);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            color: var(--primary-red);
            font-size: 24px;
        }
        
        .logo-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-red);
            letter-spacing: -0.5px;
        }
        
        /* Bot√≥n Subir - TEXTO REDUCIDO */
        .upload-main-btn { 
            background: var(--primary-red); 
            color: var(--white); 
            border: none; 
            padding: 8px 16px;
            border-radius: var(--border-radius); 
            font-family: 'Poppins', sans-serif;
            font-weight: 500; 
            font-size: 14px;
            cursor: pointer; 
            transition: all 0.2s; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
        }
        
        .upload-main-btn:hover { 
            background: var(--dark-red); 
            transform: translateY(-2px); 
        }
        
        /* ========== CUADR√çCULA DE VIDEOS ========== */
        .videos-container { 
            padding: 20px; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--light-gray);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        /* CUADR√çCULA MEJORADA - 4 columnas por defecto */
        .videos-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
            gap: 20px; 
        }
        
        .video-item { 
            background: var(--dark-gray); 
            border-radius: var(--border-radius); 
            overflow: hidden; 
            box-shadow: var(--shadow); 
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid transparent;
            position: relative;
        }
        
        .video-item:hover { 
            transform: translateY(-5px); 
            border-color: var(--primary-red);
            box-shadow: 0 8px 20px rgba(211, 47, 47, 0.2);
        }
        
        .video-thumb { 
            width: 100%; 
            height: 160px; 
            overflow: hidden; 
            background: var(--medium-gray); 
            position: relative;
        }
        
        .video-thumb img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: transform 0.3s ease;
        }
        
        .video-item:hover .video-thumb img {
            transform: scale(1.05);
        }
        
        .video-time { 
            position: absolute; 
            bottom: 10px; 
            right: 10px; 
            background: rgba(0,0,0,0.85); 
            color: var(--white); 
            padding: 3px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: 500;
        }
        
        .video-content { 
            padding: 15px; 
        }
        
        .video-title { 
            font-size: 14px; 
            font-weight: 500;
            margin-bottom: 8px; 
            display: -webkit-box; 
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; 
            overflow: hidden;
            line-height: 1.4;
        }
        
        .video-stats { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            color: var(--light-gray); 
            font-size: 12px; 
        }
        
        .video-size {
            color: #aaa;
        }
        
        .video-date {
            color: #888;
            font-size: 11px;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--light-gray);
        }
        
        .empty-state i {
            font-size: 48px;
            color: var(--primary-red);
            margin-bottom: 15px;
            opacity: 0.7;
        }
        
        /* ========== PANTALLA DE SUBIDA ========== */
        .upload-screen.active { 
            display: block; 
            min-height: 100vh;
            animation: fadeIn 0.3s ease;
        }
        
        .upload-screen { display: none; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Header subida */
        .upload-header { 
            background: var(--dark-gray); 
            padding: 15px 20px; 
            display: flex; 
            align-items: center; 
            border-bottom: 2px solid var(--primary-red); 
        }
        
        .back-btn { 
            background: var(--medium-gray); 
            color: var(--white); 
            border: none; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 16px; 
            transition: all 0.2s; 
            margin-right: 15px;
        }
        
        .back-btn:hover { 
            background: var(--primary-red); 
        }
        
        .upload-title { 
            font-size: 18px; 
            font-weight: 600; 
            color: var(--white); 
        }
        
        /* ========== SISTEMA DE SELECCI√ìN NUEVO ========== */
        .upload-content {
            max-width: 600px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        /* √Årea de selecci√≥n - COMPLETAMENTE NUEVA */
        .selection-area {
            background: var(--dark-gray);
            border-radius: var(--border-radius);
            padding: 40px 30px;
            text-align: center;
            border: 2px dashed var(--medium-gray);
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .selection-area.active {
            border-color: var(--primary-red);
            background: rgba(211, 47, 47, 0.05);
        }
        
        .upload-icon {
            font-size: 48px;
            color: var(--primary-red);
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .selection-text h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--white);
        }
        
        .selection-text p {
            color: var(--light-gray);
            margin-bottom: 25px;
            font-size: 14px;
        }
        
        /* Bot√≥n de selecci√≥n - NUEVO DISE√ëO */
        .select-btn {
            background: var(--primary-red);
            color: var(--white);
            border: none;
            padding: 12px 30px;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .select-btn:hover {
            background: var(--dark-red);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            font-size: 12px;
            color: #888;
            margin-top: 15px;
        }
        
        /* √Årea de arrastrar y soltar */
        .drag-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(211, 47, 47, 0.1);
            border: 3px dashed var(--primary-red);
            border-radius: var(--border-radius);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .drag-overlay.active {
            display: flex;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        .drag-text {
            background: var(--primary-red);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            font-weight: 500;
        }
        
        /* ========== PANEL DE PROGRESO ========== */
        .upload-panel {
            background: var(--dark-gray);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 20px;
            display: none;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .upload-panel.active {
            display: block;
        }
        
        .file-details {
            margin-bottom: 20px;
        }
        
        .file-name {
            font-weight: 500;
            color: var(--white);
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .file-size {
            color: var(--light-gray);
            font-size: 13px;
        }
        
        .progress-container {
            background: var(--medium-gray);
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .progress-percent {
            font-weight: 600;
            color: var(--primary-red);
        }
        
        .progress-speed {
            color: #aaa;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--black);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary-red);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .upload-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }
        
        .cancel-btn {
            background: transparent;
            color: var(--light-gray);
            border: 1px solid var(--medium-gray);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cancel-btn:hover {
            background: var(--medium-gray);
            color: var(--white);
        }
        
        /* ========== PANTALLA REPRODUCTOR ========== */
        .player-screen.active { 
            display: block; 
            min-height: 100vh;
        }
        
        .player-screen { display: none; }
        
        .player-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .video-player {
            width: 100%;
            background: var(--black);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        #player-video {
            width: 100%;
            max-height: 70vh;
            display: block;
        }
        
        .player-info {
            background: var(--dark-gray);
            border-radius: var(--border-radius);
            padding: 20px;
        }
        
        .player-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--white);
        }
        
        .player-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            color: var(--light-gray);
            font-size: 14px;
        }
        
        .player-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .download-btn {
            background: var(--primary-red);
            color: var(--white);
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .download-btn:hover {
            background: var(--dark-red);
            transform: translateY(-2px);
        }
        
        /* ========== NOTIFICACIONES ========== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-red);
            color: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 10000;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
        }
        
        .notification.error {
            background: var(--dark-red);
        }
        
        .notification.success {
            background: #2e7d32;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .videos-grid { 
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            }
        }
        
        @media (max-width: 768px) {
            .videos-grid { 
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
                gap: 15px; 
            }
            
            .video-thumb { 
                height: 140px; 
            }
            
            .logo-text {
                font-size: 18px;
            }
            
            .upload-main-btn {
                font-size: 13px;
                padding: 7px 14px;
            }
        }
        
        @media (max-width: 480px) {
            .videos-grid { 
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            }
            
            .video-thumb { 
                height: 120px; 
            }
            
            .logo-text {
                font-size: 16px;
            }
            
            .upload-main-btn {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .videos-container {
                padding: 15px;
            }
        }
        
        /* Estado de carga */
        .loading {
            display: flex;
            justify-content: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--medium-gray);
            border-top-color: var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ========== PANTALLA PRINCIPAL ========== -->
    <div id="main-screen" class="main-screen active">
        <header class="main-header">
            <div class="logo-container">
                <i class="fas fa-play-circle logo-icon"></i>
                <span class="logo-text">CPVideos</span>
            </div>
            <button id="upload-main-btn" class="upload-main-btn">
                <i class="fas fa-plus"></i> Subir
            </button>
        </header>

        <main class="videos-container">
            <h2 class="section-title">Videos Recientes</h2>
            
            <!-- CUADR√çCULA DE VIDEOS -->
            <div id="videos-grid" class="videos-grid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- ========== PANTALLA DE SUBIDA ========== -->
    <div id="upload-screen" class="upload-screen">
        <header class="upload-header">
            <button id="back-btn" class="back-btn">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="upload-title">Subir Video</h2>
        </header>

        <div class="upload-content">
            <!-- SISTEMA DE SELECCI√ìN NUEVO -->
            <div class="selection-area" id="selection-area">
                <div class="drag-overlay" id="drag-overlay">
                    <div class="drag-text">Suelta el video aqu√≠</div>
                </div>
                
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <div class="selection-text">
                    <h3>Selecciona tu video</h3>
                    <p>Arrastra y suelta un archivo de video aqu√≠ o haz clic para buscarlo</p>
                </div>
                
                <input type="file" id="file-input" class="file-input" accept="video/*">
                <button id="select-btn" class="select-btn">
                    <i class="fas fa-folder-open"></i> Buscar Video
                </button>
                
                <p class="file-info">MP4, AVI, MOV, MKV, WEBM ‚Ä¢ M√°ximo 50MB</p>
            </div>

            <!-- PANEL DE PROGRESO -->
            <div id="upload-panel" class="upload-panel">
                <div class="file-details">
                    <div class="file-name" id="file-name">video.mp4</div>
                    <div class="file-size" id="file-size">0 MB</div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-header">
                        <span class="progress-percent" id="progress-percent">0%</span>
                        <span class="progress-speed" id="progress-speed">0 KB/s</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>
                
                <div class="upload-actions">
                    <button id="cancel-upload-btn" class="cancel-btn">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== PANTALLA REPRODUCTOR ========== -->
    <div id="player-screen" class="player-screen">
        <header class="upload-header">
            <button id="close-player-btn" class="back-btn">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="upload-title" id="player-header-title">Reproduciendo</h2>
        </header>

        <div class="player-container">
            <div class="video-player">
                <video id="player-video" controls autoplay>
                    Tu navegador no soporta la reproducci√≥n de videos.
                </video>
            </div>
            
            <div class="player-info">
                <h3 class="player-title" id="player-video-title">T√≠tulo del Video</h3>
                <div class="player-meta">
                    <span id="player-duration"><i class="fas fa-clock"></i> 0:00</span>
                    <span id="player-views"><i class="fas fa-eye"></i> 0 vistas</span>
                    <span id="player-date"><i class="fas fa-calendar"></i> <span id="upload-time-text">Hoy</span></span>
                </div>
                <button id="download-video-btn" class="download-btn">
                    <i class="fas fa-download"></i> Descargar Video
                </button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ========== VARIABLES GLOBALES ==========
        let videos = [];
        let selectedFile = null;
        let uploadInProgress = false;
        let uploadStartTime = null;
        let currentUploadXHR = null;
        let socket = null;

        // ========== ELEMENTOS DEL DOM ==========
        const screens = {
            main: document.getElementById('main-screen'),
            upload: document.getElementById('upload-screen'),
            player: document.getElementById('player-screen')
        };
        
        // Pantalla principal
        const uploadMainBtn = document.getElementById('upload-main-btn');
        const videosGrid = document.getElementById('videos-grid');
        
        // Pantalla de subida (NUEVO SISTEMA)
        const backBtn = document.getElementById('back-btn');
        const selectionArea = document.getElementById('selection-area');
        const fileInput = document.getElementById('file-input');
        const selectBtn = document.getElementById('select-btn');
        const dragOverlay = document.getElementById('drag-overlay');
        const uploadPanel = document.getElementById('upload-panel');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const progressPercent = document.getElementById('progress-percent');
        const progressSpeed = document.getElementById('progress-speed');
        const progressFill = document.getElementById('progress-fill');
        const cancelUploadBtn = document.getElementById('cancel-upload-btn');
        
        // Pantalla reproductor
        const closePlayerBtn = document.getElementById('close-player-btn');
        const playerVideo = document.getElementById('player-video');
        const playerVideoTitle = document.getElementById('player-video-title');
        const playerHeaderTitle = document.getElementById('player-header-title');
        const playerDuration = document.getElementById('player-duration');
        const playerViews = document.getElementById('player-views');
        const uploadTimeText = document.getElementById('upload-time-text');
        const downloadVideoBtn = document.getElementById('download-video-btn');

        // ========== FUNCI√ìN CORREGIDA: CALCULAR TIEMPO DESDE SUBIDA ==========
        function calculateTimeAgo(dateString) {
            if (!dateString) return 'Reciente';
            
            try {
                const uploadDate = new Date(dateString);
                const now = new Date();
                const diffMs = now - uploadDate;
                
                // Si la fecha es inv√°lida
                if (isNaN(diffMs)) return 'Reciente';
                
                const diffSeconds = Math.floor(diffMs / 1000);
                const diffMinutes = Math.floor(diffSeconds / 60);
                const diffHours = Math.floor(diffMinutes / 60);
                const diffDays = Math.floor(diffHours / 24);
                const diffWeeks = Math.floor(diffDays / 7);
                const diffMonths = Math.floor(diffDays / 30);
                const diffYears = Math.floor(diffDays / 365);
                
                // ‚úÖ CORRECCI√ìN: Mostrar el tiempo exacto desde la subida
                if (diffYears > 0) {
                    return `hace ${diffYears} ${diffYears === 1 ? 'a√±o' : 'a√±os'}`;
                } else if (diffMonths > 0) {
                    return `hace ${diffMonths} ${diffMonths === 1 ? 'mes' : 'meses'}`;
                } else if (diffWeeks > 0) {
                    return `hace ${diffWeeks} ${diffWeeks === 1 ? 'semana' : 'semanas'}`;
                } else if (diffDays > 0) {
                    return `hace ${diffDays} ${diffDays === 1 ? 'd√≠a' : 'd√≠as'}`;
                } else if (diffHours > 0) {
                    return `hace ${diffHours} ${diffHours === 1 ? 'hora' : 'horas'}`;
                } else if (diffMinutes > 0) {
                    return `hace ${diffMinutes} ${diffMinutes === 1 ? 'minuto' : 'minutos'}`;
                } else {
                    return 'hace unos segundos';
                }
            } catch (error) {
                console.error('Error calculando fecha:', error, 'Fecha:', dateString);
                return 'Reciente';
            }
        }

        // ========== FUNCIONES PRINCIPALES ==========
        
        // Cambiar entre pantallas
        function switchScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            
            if (screenName === 'main') {
                screens.main.classList.add('active');
                resetUploadForm();
                loadVideos();
            } else if (screenName === 'upload') {
                screens.upload.classList.add('active');
            } else if (screenName === 'player') {
                screens.player.classList.add('active');
            }
        }

        // Cargar videos
        async function loadVideos() {
            try {
                videosGrid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                
                const response = await fetch('/api/videos');
                if (!response.ok) throw new Error('Error API');
                
                videos = await response.json();
                renderVideosGrid();
            } catch (error) {
                console.error('Error cargando videos:', error);
                showNotification('Error al cargar videos', 'error');
                videosGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Error al cargar videos</h3>
                        <p>No se pudieron cargar los videos. Intenta de nuevo.</p>
                        <button onclick="loadVideos()" class="select-btn" style="margin-top: 15px;">
                            <i class="fas fa-redo"></i> Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // Renderizar cuadr√≠cula de videos - ‚úÖ CON TIEMPO CORRECTO
        function renderVideosGrid() {
            if (videos.length === 0) {
                videosGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-video-slash"></i>
                        <h3>No hay videos</h3>
                        <p>Sube el primer video haciendo clic en el bot√≥n "Subir"</p>
                    </div>
                `;
                return;
            }
            
            videosGrid.innerHTML = videos.map(video => {
                // ‚úÖ CALCULAR TIEMPO DESDE SUBIDA CORRECTAMENTE
                const timeAgo = calculateTimeAgo(video.uploaded_at);
                
                return `
                <div class="video-item" data-id="${video.id}">
                    <div class="video-thumb">
                        <img src="${video.thumbnail || 'https://placehold.co/400x160/d32f2f/ffffff?text=Video'}" 
                             alt="${video.title}"
                             onerror="this.src='https://placehold.co/400x160/2a2a2a/ffffff?text=Thumbnail'">
                        <span class="video-time">${video.duration || '0:00'}</span>
                    </div>
                    <div class="video-content">
                        <h4 class="video-title">${video.title || 'Video sin t√≠tulo'}</h4>
                        <div class="video-stats">
                            <span class="video-size">${video.size || '0 MB'}</span>
                            <span class="video-date">
                                <i class="fas fa-clock" style="font-size: 10px;"></i> ${timeAgo}
                            </span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            // Event listeners para videos
            document.querySelectorAll('.video-item').forEach(item => {
                item.addEventListener('click', function() {
                    const videoId = this.getAttribute('data-id');
                    openVideoPlayer(videoId);
                });
            });
        }

        // Abrir reproductor - ‚úÖ CON TIEMPO CORRECTO
        async function openVideoPlayer(videoId) {
            try {
                const response = await fetch(`/api/videos/${videoId}`);
                const video = await response.json();
                
                playerVideo.src = `/uploads/${video.filename}`;
                playerVideoTitle.textContent = video.title;
                playerHeaderTitle.textContent = `Reproduciendo: ${video.title.substring(0, 30)}${video.title.length > 30 ? '...' : ''}`;
                playerDuration.innerHTML = `<i class="fas fa-clock"></i> ${video.duration || '0:00'}`;
                playerViews.innerHTML = `<i class="fas fa-eye"></i> ${video.views || 0} vistas`;
                
                // ‚úÖ MOSTRAR TIEMPO DESDE SUBIDA CORRECTAMENTE
                const timeAgo = calculateTimeAgo(video.uploaded_at);
                uploadTimeText.textContent = timeAgo;
                
                downloadVideoBtn.onclick = () => {
                    window.open(`/api/videos/${videoId}/download`, '_blank');
                };
                
                switchScreen('player');
            } catch (error) {
                console.error('Error abriendo video:', error);
                showNotification('Error al cargar el video', 'error');
            }
        }

        // ========== NUEVO SISTEMA DE SUBIDA ==========
        
        // Activar √°rea de selecci√≥n
        function activateSelectionArea() {
            selectionArea.classList.add('active');
            dragOverlay.classList.add('active');
        }
        
        // Desactivar √°rea de selecci√≥n
        function deactivateSelectionArea() {
            selectionArea.classList.remove('active');
            dragOverlay.classList.remove('active');
        }
        
        // Manejar selecci√≥n de archivo
        function handleFileSelect(file) {
            if (!file) return;
            
            console.log('Archivo seleccionado:', file.name);
            
            // Validaciones
            if (!file.type.startsWith('video/')) {
                showNotification('Selecciona un archivo de video v√°lido', 'error');
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) {
                showNotification('El video es demasiado grande (m√°x. 50MB)', 'error');
                return;
            }
            
            selectedFile = file;
            
            // Mostrar panel de subida
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            uploadPanel.classList.add('active');
            
            // Iniciar subida autom√°ticamente
            uploadVideo(file);
        }
        
        // Subir video
        function uploadVideo(file) {
            if (uploadInProgress) {
                showNotification('Ya hay una subida en progreso', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('video', file);
            
            currentUploadXHR = new XMLHttpRequest();
            uploadInProgress = true;
            uploadStartTime = Date.now();
            
            // Progreso
            currentUploadXHR.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    progressFill.style.width = `${percent}%`;
                    progressPercent.textContent = `${percent}%`;
                    
                    const elapsed = (Date.now() - uploadStartTime) / 1000;
                    const speed = e.loaded / elapsed;
                    
                    if (speed > 1024 * 1024) {
                        progressSpeed.textContent = `${(speed / (1024 * 1024)).toFixed(1)} MB/s`;
                    } else if (speed > 1024) {
                        progressSpeed.textContent = `${(speed / 1024).toFixed(1)} KB/s`;
                    } else {
                        progressSpeed.textContent = `${Math.round(speed)} B/s`;
                    }
                }
            });
            
            // Completado
            currentUploadXHR.addEventListener('load', () => {
                uploadInProgress = false;
                
                if (currentUploadXHR.status === 200) {
                    const response = JSON.parse(currentUploadXHR.responseText);
                    progressPercent.textContent = '100%';
                    progressSpeed.textContent = 'Completado ‚úì';
                    
                    showNotification(`Video "${response.title}" subido exitosamente`, 'success');
                    
                    setTimeout(() => {
                        switchScreen('main');
                    }, 1500);
                } else {
                    showNotification('Error al subir el video', 'error');
                }
            });
            
            // Error
            currentUploadXHR.addEventListener('error', () => {
                uploadInProgress = false;
                showNotification('Error de conexi√≥n', 'error');
            });
            
            // Cancelado
            currentUploadXHR.addEventListener('abort', () => {
                uploadInProgress = false;
                showNotification('Subida cancelada', 'error');
            });
            
            // Iniciar
            currentUploadXHR.open('POST', '/api/upload');
            currentUploadXHR.send(formData);
        }
        
        // Cancelar subida
        function cancelUpload() {
            if (uploadInProgress && currentUploadXHR) {
                if (confirm('¬øCancelar la subida?')) {
                    currentUploadXHR.abort();
                    switchScreen('main');
                }
            } else {
                switchScreen('main');
            }
        }
        
        // Reiniciar formulario
        function resetUploadForm() {
            selectedFile = null;
            uploadInProgress = false;
            uploadStartTime = null;
            currentUploadXHR = null;
            
            fileInput.value = '';
            uploadPanel.classList.remove('active');
            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
            progressSpeed.textContent = '0 KB/s';
            deactivateSelectionArea();
        }

        // ========== UTILIDADES ==========
        
        // Mostrar notificaci√≥n
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        // Formatear tama√±o de archivo
        function formatFileSize(bytes) {
            if (!bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ========== WEB SOCKETS ==========
        
        function setupWebSocket() {
            try {
                socket = io();
                
                socket.on('connect', () => {
                    console.log('‚úÖ WebSocket conectado');
                });
                
                socket.on('video-uploaded', () => {
                    loadVideos();
                });
                
                socket.on('video-processed', () => {
                    loadVideos();
                });
            } catch (error) {
                console.error('‚ùå Error WebSocket:', error);
            }
        }

        // ========== CONFIGURACI√ìN DE EVENTOS ==========
        
        function setupEventListeners() {
            // Navegaci√≥n
            uploadMainBtn.addEventListener('click', () => switchScreen('upload'));
            backBtn.addEventListener('click', cancelUpload);
            closePlayerBtn.addEventListener('click', () => {
                playerVideo.pause();
                playerVideo.src = '';
                switchScreen('main');
            });
            
            // ===== NUEVO SISTEMA DE SELECCI√ìN =====
            
            // Bot√≥n de selecci√≥n
            selectBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Input de archivo
            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    handleFileSelect(e.target.files[0]);
                    fileInput.value = '';
                }
            });
            
            // Drag and drop
            selectionArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                activateSelectionArea();
            });
            
            selectionArea.addEventListener('dragleave', (e) => {
                if (!selectionArea.contains(e.relatedTarget)) {
                    deactivateSelectionArea();
                }
            });
            
            selectionArea.addEventListener('drop', (e) => {
                e.preventDefault();
                deactivateSelectionArea();
                
                if (e.dataTransfer.files[0]) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });
            
            // Bot√≥n cancelar
            cancelUploadBtn.addEventListener('click', cancelUpload);
        }

        // ========== INICIALIZACI√ìN ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ CPVideos - Iniciando...');
            
            setupEventListeners();
            setupWebSocket();
            loadVideos();
            
            console.log('‚úÖ Aplicaci√≥n lista - Tiempo de subida corregido');
        });
        
        // Manejo de errores
        window.onerror = function(msg) {
            console.error('Error:', msg);
            return true;
        };
    </script>
</body>
</html>